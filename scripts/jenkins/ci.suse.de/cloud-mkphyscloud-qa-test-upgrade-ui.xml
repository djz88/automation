<?xml version="1.0" encoding="UTF-8"?>
<project>
  <actions/>
  <description>Run upgrade on the selected cloud
Useful only for cloud that was built by mkcloud.
This job is making use of mkcloud.config file stored on admin node which contains
configuration values used from the jenkins cloud scenario

Mandatory parameter: hw_number
&lt;!-- Managed by Jenkins Job Builder --&gt;</description>
  <logRotator class="hudson.tasks.LogRotator">
    <daysToKeep>-1</daysToKeep>
    <numToKeep>15</numToKeep>
    <artifactDaysToKeep>-1</artifactDaysToKeep>
    <artifactNumToKeep>-1</artifactNumToKeep>
  </logRotator>
  <keepDependencies>false</keepDependencies>
  <properties>
    <hudson.model.ParametersDefinitionProperty>
      <parameterDefinitions>
        <hudson.model.StringParameterDefinition>
          <name>hw_number</name>
          <description>Mandatory, number of the QA cloud server</description>
          <defaultValue/>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>upgrade_cloudsource</name>
          <description>Mandatory, mkcloud cloudsource target name, e.g. develcloud7</description>
          <defaultValue>develcloud7</defaultValue>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>scenario_name</name>
          <description>Optional; scenario name which typically is an integer with a single letter</description>
          <defaultValue/>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>cct_repo_owner</name>
          <description>Optional; scenario name which typically is an integer with a single letter</description>
          <defaultValue>SUSE-Cloud</defaultValue>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>cct_git_url</name>
          <description>Optional, cct git repo url</description>
          <defaultValue>https://github.com/$cct_repo_owner/cct.git</defaultValue>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>cct_checkout_branch</name>
          <description>Optional, pick git branch to be tested</description>
          <defaultValue>cloud6</defaultValue>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>scenario_job_name</name>
          <description>Optional; name of the scenario jenkins job that is used to trigger this job</description>
          <defaultValue/>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>scenario_build_number</name>
          <description>Optional; scenario build number that triggered this job</description>
          <defaultValue/>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>scenario_build_number</name>
          <description>Optional; scenario build number that triggered this job</description>
          <defaultValue/>
        </hudson.model.StringParameterDefinition>
      </parameterDefinitions>
    </hudson.model.ParametersDefinitionProperty>
    <com.sonyericsson.jenkins.plugins.bfa.model.ScannerJobProperty plugin="build-failure-analyzer@">
      <doNotScan>false</doNotScan>
    </com.sonyericsson.jenkins.plugins.bfa.model.ScannerJobProperty>
  </properties>
  <scm class="hudson.scm.NullSCM"/>
  <assignedNode>cloud-mkphyscloud-gate-qa</assignedNode>
  <canRoam>false</canRoam>
  <disabled>false</disabled>
  <blockBuildWhenDownstreamBuilding>false</blockBuildWhenDownstreamBuilding>
  <blockBuildWhenUpstreamBuilding>false</blockBuildWhenUpstreamBuilding>
  <triggers/>
  <concurrentBuild>true</concurrentBuild>
  <builders>
    <hudson.tasks.Shell>
      <command>#!/bin/bash
admin=crowbar$hw_number;
cloud=qa$hw_number;
result=0

artifacts_dir=$WORKSPACE/.artifacts
rm -rf $artifacts_dir
mkdir -p $artifacts_dir
touch $artifacts_dir/.ignore

ps aux | grep ping

ssh root@$admin "
  export cloud=$cloud;
  export cloudsource=$upgrade_cloudsource
  export upgrade_cloudsource=$upgrade_cloudsource
  export cct_checkout_branch=$cct_checkout_branch
  export cct_ui_tests=true
" '
  set -x;
  hostname -f;
  source mkcloud.config;
  source scripts/qa_crowbarsetup.sh;
  export cloudsource=$upgrade_cloudsource

  onadmin_check_admin_server_upgraded

  export cct_tests=feature:ui:upgrade:pgsql:create
  onadmin_run_cct

  export cloudsource=$upgrade_cloudsource
  onadmin_prepare_cloudupgrade_nodes_repos_6_to_7
  export cct_tests=feature:ui:upgrade:nodes:repos
  onadmin_run_cct

  export cct_tests=feature:ui:upgrade:os-services:stop
  onadmin_run_cct

  export cct_tests=feature:ui:upgrade:os-db:backup
  onadmin_run_cct

  export cct_tests=feature:ui:upgrade:nodes:upgrade
  onadmin_run_cct

'
# Stop the ping script
ping_instances stop $fips

# Show results from ping log files
ssh root@$admin "
  source mkcloud.config;
  source scripts/qa_crowbarsetup.sh;
  get_novacontroller
  oncontroller testpostupgrade
"
</command>
    </hudson.tasks.Shell>
  </builders>
  <publishers>
    <hudson.tasks.ArtifactArchiver>
      <artifacts>.artifacts/**</artifacts>
      <latestOnly>false</latestOnly>
      <allowEmptyArchive>true</allowEmptyArchive>
      <onlyIfSuccessful>false</onlyIfSuccessful>
      <fingerprint>false</fingerprint>
      <defaultExcludes>true</defaultExcludes>
      <caseSensitive>true</caseSensitive>
    </hudson.tasks.ArtifactArchiver>
  </publishers>
  <buildWrappers>
    <org.jenkinsci.plugins.buildnamesetter.BuildNameSetter plugin="build-name-setter@">
      <template>#${BUILD_NUMBER} - ${scenario_name} - qa$hw_number - upgrade-ui</template>
      <runAtStart>true</runAtStart>
      <runAtEnd>true</runAtEnd>
    </org.jenkinsci.plugins.buildnamesetter.BuildNameSetter>
    <hudson.plugins.timestamper.TimestamperBuildWrapper plugin="timestamper@"/>
  </buildWrappers>
</project>
